@* <!-- Views/Shared/_SearchFilters.cshtml -->
@{
    var categories = ViewBag.Categories as List<DataFileCategory> ?? new List<DataFileCategory>();
}

<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi bi-funnel"></i> فیلترها و مرتب‌سازی
        </h5>
    </div>

    <div class="card-body">
        <form asp-action="Search" method="get" class="row g-3">
            <!-- جستجوی متنی -->
            <div class="col-12">
                <label for="query" class="form-label">جستجوی فایل‌ها</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="query" name="query"
                           value="@ViewBag.SearchQuery" placeholder="عنوان، توضیحات یا تگ‌ها...">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>

            <!-- دسته‌بندی -->
            <div class="col-md-6">
                <label for="categoryId" class="form-label">دسته‌بندی</label>
                <select class="form-select" id="categoryId" name="categoryId">
                    <option value="">همه دسته‌بندی‌ها</option>
                    @foreach (var cat in categories)
                    {
                        <option value="@cat.Id"
                                selected="@(ViewBag.CategoryId?.ToString() == cat.Id.ToString())">
                            @cat.Name
                        </option>
                    }
                </select>
            </div>

            <!-- بازه قیمت -->
            <div class="col-md-6">
                <label for="sortBy" class="form-label">مرتب‌سازی</label>
                <select class="form-select" id="sortBy" name="sortBy">
                    <option value="newest" selected="@(ViewBag.SortBy == "newest")">جدیدترین</option>
                    <option value="popular" selected="@(ViewBag.SortBy == "popular")">محبوب‌ترین</option>
                    <option value="views" selected="@(ViewBag.SortBy == "views")">پربازدیدترین</option>
                    <option value="rating" selected="@(ViewBag.SortBy == "rating")">برترین امتیاز</option>
                    <option value="price-asc" selected="@(ViewBag.SortBy == "price-asc")">ارزان‌ترین</option>
                    <option value="price-desc" selected="@(ViewBag.SortBy == "price-desc")">گران‌ترین</option>
                </select>
            </div>

            <!-- بازه قیمت -->
            <div class="col-md-6">
                <label for="minPrice" class="form-label">حداقل قیمت (تومان)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="minPrice" name="minPrice"
                           value="@ViewBag.MinPrice" placeholder="0" min="0" step="1000">
                    <span class="input-group-text">تومان</span>
                </div>
            </div>

            <div class="col-md-6">
                <label for="maxPrice" class="form-label">حداکثر قیمت (تومان)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="maxPrice" name="maxPrice"
                           value="@ViewBag.MaxPrice" placeholder="1000000" min="0" step="1000">
                    <span class="input-group-text">تومان</span>
                </div>
            </div>

            <!-- دکمه‌ها -->
            <div class="col-12">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-primary me-md-2">
                        <i class="bi bi-search"></i> اعمال فیلترها
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> پاک کردن
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- نمایش اطلاعات فیلترها -->
@if (!string.IsNullOrEmpty(ViewBag.SearchQuery) || ViewBag.CategoryId != null ||
     ViewBag.MinPrice != null || ViewBag.MaxPrice != null)
{
    <div class="alert alert-info mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-funnel"></i>
                <strong>فیلترهای فعال:</strong>

                @if (!string.IsNullOrEmpty(ViewBag.SearchQuery))
                {
                    <span class="badge bg-primary me-2">جستجو: @ViewBag.SearchQuery</span>
                }

                @if (ViewBag.CategoryId != null)
                {
                    var category = categories.FirstOrDefault(c => c.Id == ViewBag.CategoryId);
                    if (category != null)
                    {
                        <span class="badge bg-success me-2">دسته‌بندی: @category.Name</span>
                    }
                }

                @if (ViewBag.MinPrice != null || ViewBag.MaxPrice != null)
                {
                    var priceRange = "";
                    if (ViewBag.MinPrice != null && ViewBag.MaxPrice != null)
                    {
                        priceRange = $"{ViewBag.MinPrice} تا {ViewBag.MaxPrice}";
                    }
                    else if (ViewBag.MinPrice != null)
                    {
                        priceRange = $"از {ViewBag.MinPrice}";
                    }
                    else if (ViewBag.MaxPrice != null)
                    {
                        priceRange = $"تا {ViewBag.MaxPrice}";
                    }

                    <span class="badge bg-warning me-2">قیمت: @priceRange تومان</span>
                }
            </div>
            <a asp-action="Index" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-x-lg"></i>
            </a>
        </div>
    </div>
} *@


<!-- Views/Shared/_SearchFilters.cshtml -->
@{
    var categories = ViewBag.Categories as List<DataFileCategory> ?? new List<DataFileCategory>();
}

<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi bi-funnel"></i> فیلترها و مرتب‌سازی
        </h5>
    </div>

    <div class="card-body">
        <form asp-action="Search" method="get" class="row g-3">
            <!-- ردیف اول: جستجوی سریع -->
            <div class="col-md-6">
                <label for="query" class="form-label">جستجوی متنی</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="query" name="query"
                           value="@ViewBag.SearchQuery"
                           placeholder="عنوان، توضیحات یا تگ‌ها...">
                    <span class="input-group-text">
                        <i class="bi bi-text-left"></i>
                    </span>
                </div>
                <small class="form-text text-muted">در متن فایل‌ها جستجو کنید</small>
            </div>

            <div class="col-md-6">
                <label for="uniqueCode" class="form-label">جستجوی کد یکتا</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="uniqueCode" name="uniqueCode"
                           value="@ViewBag.SearchUniqueCode"
                           placeholder="مثال: DF123ABC456">
                    <span class="input-group-text">
                        <i class="bi bi-hash"></i>
                    </span>
                </div>
                <small class="form-text text-muted">کد اختصاصی فایل را وارد کنید</small>
            </div>

            <!-- ردیف دوم: فیلترهای اصلی -->
            <div class="col-md-4">
                <label for="categoryId" class="form-label">دسته‌بندی</label>
                <select class="form-select" id="categoryId" name="categoryId">
                    <option value="">همه دسته‌بندی‌ها</option>
                    @foreach (var cat in categories)
                    {
                        <option value="@cat.Id"
                                selected="@(ViewBag.CategoryId?.ToString() == cat.Id.ToString())">
                            @cat.Name
                        </option>
                    }
                </select>
            </div>


            <!-- ردیف سوم: بازه قیمت -->
            <div class="col-md-6">
                <label for="minPrice" class="form-label">حداقل قیمت (تومان)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="minPrice" name="minPrice"
                           value="@ViewBag.MinPrice" placeholder="0" min="0" step="1000">
                    <span class="input-group-text">تومان</span>
                </div>
            </div>

            <div class="col-md-6">
                <label for="maxPrice" class="form-label">حداکثر قیمت (تومان)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="maxPrice" name="maxPrice"
                           value="@ViewBag.MaxPrice" placeholder="1000000" min="0" step="1000">
                    <span class="input-group-text">تومان</span>
                </div>
            </div>

            <!-- ردیف چهارم: دکمه‌ها -->
            <div class="col-12">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-primary me-md-2">
                        <i class="bi bi-search"></i> اعمال فیلترها
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> پاک کردن فیلترها
                    </a>

                    <!-- لینک جستجوی سریع کد (اگر کد وارد شده) -->
                    @if (!string.IsNullOrEmpty(ViewBag.SearchUniqueCode))
                    {
                        <a href="@Url.Action("SearchByCode", new { code = ViewBag.SearchUniqueCode })"
                           class="btn btn-info ms-2">
                            <i class="bi bi-arrow-right-circle"></i> برو به این کد
                        </a>
                    }
                </div>
            </div>
        </form>
    </div>
</div>

<!-- نمایش اطلاعات فیلترهای فعال -->
@{
    var hasActiveFilters = !string.IsNullOrEmpty(ViewBag.SearchQuery) ||
                          !string.IsNullOrEmpty(ViewBag.SearchUniqueCode) ||
                          ViewBag.CategoryId != null ||
                          ViewBag.MinPrice != null ||
                          ViewBag.MaxPrice != null ||
                          ViewBag.IsActive != null ||
                          (ViewBag.SortBy != null && ViewBag.SortBy != "newest");
}

@if (hasActiveFilters)
{
    <div class="alert alert-info mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-funnel-fill"></i>
                <strong>فیلترهای فعال:</strong>

                @if (!string.IsNullOrEmpty(ViewBag.SearchQuery))
                {
                    <span class="badge bg-primary me-2 mb-1">
                        <i class="bi bi-text-left"></i> متن: @ViewBag.SearchQuery
                    </span>
                }

                @if (!string.IsNullOrEmpty(ViewBag.SearchUniqueCode))
                {
                    <span class="badge bg-info me-2 mb-1">
                        <i class="bi bi-hash"></i> کد: @ViewBag.SearchUniqueCode
                    </span>
                }

                @if (ViewBag.CategoryId != null)
                {
                    var category = categories.FirstOrDefault(c => c.Id == ViewBag.CategoryId);
                    if (category != null)
                    {
                        <span class="badge bg-success me-2 mb-1">
                            <i class="bi bi-folder"></i> دسته: @category.Name
                        </span>
                    }
                }

                @if (ViewBag.MinPrice != null || ViewBag.MaxPrice != null)
                {
                    var priceRange = "";
                    if (ViewBag.MinPrice != null && ViewBag.MaxPrice != null)
                    {
                        priceRange = $"{ViewBag.MinPrice:N0} تا {ViewBag.MaxPrice:N0}";
                    }
                    else if (ViewBag.MinPrice != null)
                    {
                        priceRange = $"از {ViewBag.MinPrice:N0}";
                    }
                    else if (ViewBag.MaxPrice != null)
                    {
                        priceRange = $"تا {ViewBag.MaxPrice:N0}";
                    }

                    <span class="badge bg-warning me-2 mb-1">
                        <i class="bi bi-currency-exchange"></i> قیمت: @priceRange تومان
                    </span>
                }

                @if (ViewBag.IsActive != null)
                {
                    var statusText = ViewBag.IsActive == true ? "فعال" : "غیرفعال";
                    var statusClass = ViewBag.IsActive == true ? "bg-success" : "bg-danger";

                    <span class="badge @statusClass me-2 mb-1">
                        <i class="bi bi-circle-fill"></i> وضعیت: @statusText
                    </span>
                }

                @if (ViewBag.SortBy != null && ViewBag.SortBy != "newest")
                {
                    var sortText = ViewBag.SortBy switch
                    {
                        "oldest" => "قدیمی‌ترین",
                        "popular" => "محبوب‌ترین",
                        "views" => "پربازدیدترین",
                        "downloads" => "پر دانلودترین",
                        "rating" => "برترین امتیاز",
                        "price-asc" => "ارزان‌ترین",
                        "price-desc" => "گران‌ترین",
                        "title-asc" => "عنوان (الف-ی)",
                        "title-desc" => "عنوان (ی-الف)",
                        _ => ViewBag.SortBy
                    };

                    <span class="badge bg-secondary me-2 mb-1">
                        <i class="bi bi-sort-down"></i> مرتب‌سازی: @sortText
                    </span>
                }
            </div>
            <a asp-action="Index" class="btn btn-sm btn-outline-danger" title="پاک کردن همه فیلترها">
                <i class="bi bi-x-lg"></i>
            </a>
        </div>
    </div>
}

<!-- راهنمای جستجوی کد -->
@if (!string.IsNullOrEmpty(ViewBag.SearchUniqueCode))
{
    <div class="alert alert-light border mb-3">
        <div class="d-flex">
            <div class="flex-shrink-0">
                <i class="bi bi-info-circle-fill text-primary fs-4"></i>
            </div>
            <div class="flex-grow-1 ms-3">
                <h6 class="alert-heading">راهنمای جستجوی کد</h6>
                <p class="mb-1 small">
                    • برای جستجوی دقیق، کد را کامل وارد کنید (مثال: <code>DF123ABC456</code>)
                </p>
                <p class="mb-1 small">
                    • برای جستجوی بخشی، قسمتی از کد را وارد کنید (مثال: <code>ABC</code>)
                </p>
                <p class="mb-0 small">
                    • برای دسترسی مستقیم، روی دکمه <strong>"برو به این کد"</strong> کلیک کنید
                </p>
            </div>
        </div>
    </div>
}
