@model DataFileViewModel

@{
    ViewData["Title"] = "آپلود فایل جدید";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-cloud-upload"></i>
                        @ViewData["Title"]
                    </h4>
                </div>

                <div class="card-body">
                    <form asp-action="Create" method="post" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <!-- عنوان فایل -->
                        <div class="mb-3">
                            <label asp-for="Title" class="form-label"></label>
                            <input asp-for="Title" class="form-control"
                                   placeholder="مثال: تحلیل بازار خودرو ۱۴۰۳" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                            <small class="text-muted">عنوان جذاب و واضح انتخاب کنید</small>
                        </div>

                        <!-- توضیحات -->
                        <div class="mb-3">
                            <label asp-for="Description" class="form-label"></label>
                            <textarea asp-for="Description" class="form-control"
                                      rows="4"
                                      placeholder="توضیحات کامل درباره محتوای فایل..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                            <small class="text-muted">حداقل ۱۰۰ کاراکتر توضیح دهید</small>
                        </div>

                        <div class="row">
                            <!-- قیمت -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="Price" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="Price" class="form-control"
                                           type="number"
                                           min="0"
                                           step="1000"
                                           placeholder="مثال: 50000" />
                                    <span class="input-group-text">تومان</span>
                                </div>
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>

                            <!-- دسته‌بندی -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoryId" class="form-label"></label>
                                <select asp-for="CategoryId" class="form-select"
                                        asp-items="@(new SelectList(ViewBag.Categories, "Id", "Name"))">
                                    <option value="">-- انتخاب دسته‌بندی --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- فایل اکسل -->
                        <div class="mb-3">
                            <label asp-for="UploadedFile" class="form-label"></label>
                            <div class="file-upload-area border rounded p-4 text-center">
                                <div class="mb-3">
                                    <i class="bi bi-file-earmark-excel display-4 text-success"></i>
                                </div>
                                <input asp-for="UploadedFile" class="form-control" type="file"
                                       accept=".xlsx,.xls,.csv" />
                                <span asp-validation-for="UploadedFile" class="text-danger"></span>
                                <small class="text-muted d-block mt-2">
                                    فقط فایل‌های اکسل (xlsx, xls, csv) تا سقف ۱۰ مگابایت
                                </small>
                            </div>
                        </div>

                        <!-- تگ‌ها -->
                        <div class="mb-3">
                            <label asp-for="Tags" class="form-label"></label>
                            <input asp-for="Tags" class="form-control"
                                   placeholder="مثال: تحلیل مالی, بازار سهام, بورس, اکسل پیشرفته" />
                            <span asp-validation-for="Tags" class="text-danger"></span>
                            <small class="text-muted">تگ‌ها را با کاما (,) جدا کنید</small>
                        </div>

                        <!-- وضعیت فعال -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox"
                                       checked="checked" />
                                <label asp-for="IsActive" class="form-check-label"></label>
                            </div>
                            <small class="text-muted">اگر غیرفعال باشد، در لیست نمایش داده نمی‌شود</small>
                        </div>

                        <!-- دکمه‌ها -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-action="Index" class="btn btn-outline-secondary me-md-2">
                                <i class="bi bi-x-circle"></i> انصراف
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> ذخیره فایل
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- راهنما -->
            <div class="card mt-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> راهنمای آپلود</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            <strong>فرمت‌های مجاز:</strong> .xlsx, .xls, .csv
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            <strong>حداکثر حجم:</strong> ۱۰ مگابایت
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            <strong>نکات مهم:</strong>
                            <ul class="mt-1">
                                <li>فایل نباید دارای رمز باشد</li>
                                <li>داده‌ها باید فارسی یا انگلیسی باشند</li>
                                <li>از فرمول‌های معتبر اکسل استفاده کنید</li>
                            </ul>
                        </li>
                        <li>
                            <i class="bi bi-check-circle text-success"></i>
                            <strong>پس از آپلود:</strong> فایل شما بعد از تایید در سایت نمایش داده می‌شود
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // نمایش پیش‌نمایش نام فایل
        document.getElementById('UploadedFile').addEventListener('change', function(e) {
            var fileName = e.target.files[0].name;
            var fileSize = (e.target.files[0].size / 1024 / 1024).toFixed(2); // به مگابایت
            var fileInfo = document.createElement('div');

            fileInfo.className = 'alert alert-info mt-2';
            fileInfo.innerHTML =
                '<i class="bi bi-file-earmark-excel"></i> ' +
                '<strong>فایل انتخاب شده:</strong> ' + fileName +
                ' (' + fileSize + ' مگابایت)';

            // حذف پیام قبلی اگر وجود دارد
            var prevInfo = document.querySelector('.file-info-alert');
            if (prevInfo) prevInfo.remove();

            fileInfo.className += ' file-info-alert';
            e.target.parentNode.appendChild(fileInfo);
        });

        // اعتبارسنجی سمت کلاینت برای قیمت
        document.querySelector('form').addEventListener('submit', function(e) {
            var priceInput = document.getElementById('Price');
            var price = parseFloat(priceInput.value);

            if (price < 0) {
                alert('قیمت نمی‌تواند منفی باشد');
                e.preventDefault();
                return false;
            }

            if (price > 1000000000) {
                alert('قیمت نمی‌تواند بیشتر از ۱,۰۰۰,۰۰۰,۰۰۰ تومان باشد');
                e.preventDefault();
                return false;
            }
        });
    </script>

    <style>
        .file-upload-area {
            border: 2px dashed #dee2e6;
            transition: border-color 0.3s;
        }

            .file-upload-area:hover {
                border-color: #0d6efd;
            }

        input[type="file"]::-webkit-file-upload-button {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

            input[type="file"]::-webkit-file-upload-button:hover {
                background-color: #0b5ed7;
            }
    </style>
}